$(document).ready(function(){
    getBusinessArticles()
    fetchArticlesButton()
});

function getBusinessArticles() {
    $.ajax({
        type: "GET",
        dataType: 'json',
        url: "http://api.nytimes.com/svc/topstories/v1/business.json?callback=getBusinessArticles&api-key=<%= ENV["nytimes_top_stories_api_key"]  %>",
        success: function(articles){
            var stories = articles.results;
            $.each(stories, function(index, story){
                var newArticleDate        = story.created_date;
                var lastArticleDateString = $("#top-stories-business-articles").last().children().first().data("created-date");
                var lastArticleDate       = lastArticleDateString;
                if (lastArticleDateString === undefined || newArticleDate > lastArticleDate) {
                    renderBusinessStory(story)
                }
            })
        }
    })
}

function fetchArticlesButton() {
    $("#fetch-button-articles").on("click", function(){
        getBusinessArticles()
    })
}

function renderBusinessStory(story) {
    $("#top-stories-business-articles").append(
            "<div class='top-stories-business-articles' data-created-date='"+story.created_date+"'>"
            +"<div class='row'>"
            +"<div class='medium-12 columns top-stories-business-title'>"
            +"<h4>"+story.title+"</h4>"
            +"<h6>"+story.created_date+"</h6>"
            +"</div>"
            +"</div>"
            +"<div class='row'>"
            +"<div class='medium-6 columns top-stories-business-byline'>"
            +"<p>"+story.byline+"</p>"
            +"</div>"
            +"<div class='medium-6 columns top-stories-business-section'>"
            +"<p>"+story.section+"</p>"
            +"</div>"
            +"</div>"

            +"<div class='row'>"
            +"<div class='medium-12 columns top-stories-business-abstract'>"
            +"<p>"+story.abstract+"</p>"
            +"</div>"
            +"</div>"
            +"<div class='row'>"
            +"<div>"
            +"<a class='button' href='"+story.url+"'>Read More</a>"
            +"</div>"
            +"</div>"
            +"<div>"
            +"<button id='fetch-button-articles' class='button'>Fetch</button>"
            +"</div>"
            +"<hr>"
            +"</div>"
    );
}