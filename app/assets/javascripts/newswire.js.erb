$(document).ready(function(){
    getNewswireArticles();
    fetchNewswireArticlesButton()
});

function fetchNewswireArticlesButton() {
    $("#fetch-newswire-articles").on("click", function() {
        getNewswireArticles()
    })
}

function getNewswireArticles() {
    $.ajax({
        type: "GET",
        url: "https://api.nytimes.com/svc/news/v3/content/all/all.json?api-key=<%= ENV["nytimes_newswire_api_key"]  %>",
        success: function(articles){
            var stories = articles.results;
            $.each(stories, function(index, story){
                var newArticleDate        = story.created_date;
                var lastArticleDate = $(".newswire-articles").last().data("created-date");

                if (lastArticleDate === undefined || lastArticleDate > newArticleDate) {
                    renderNewswireStory(story)
                }
                renderImage(story)
            })
        }
    })
}

function renderNewswireImage(story) {
    $(".story_image").append("<img src='" + story.multimedia[2].url + "'>");
}

function renderStockImage() {
    $(".story_image").append("<img src='http://a.dilcdn.com/bl/wp-content/uploads/sites/8/2014/03/image5.jpg'>");
}

function renderImage(story) {
    if (story.multimedia[3] === undefined) {
        renderStockImage()
    } else {
        renderNewswireImage(story)
    }
}



function renderNewswireStory(story) {
    $("#newswire-article").append(
            "<div class='newswire-articles' data-created-date='"+story.created_date+"'>"
            +"<div class='row'>"
            +"<div class='medium-12 columns newswire-title'>"
            +"<h4>"+story.title+"</h4>"
            +"<h6>"+new Date(story.created_date)+"</h6>"
            +"</div>"
            +"</div>"
            +"<div class='row'>"
            +"<div class='medium-6 columns newswire-byline'>"
            +"<p>"+story.byline+"</p>"
            +"</div>"
            +"<div class='medium-6 columns newswire-section'>"
            +"<p>"+story.section+"</p>"
            +"</div>"
            +"</div>"
            +"<div class='row'>"
            +"<div class='medium-12 columns newswire-abstract'>"
            +"<p>"+story.abstract+"</p>"
            +"</div>"
            +"</div>"
            +"<div class='row'>"
            +"<div>"
            +"<a class='button' href='"+story.url+"'>Read More</a>"
            +"</div>"
            +"<div class='row'>"
                +"<div class='medium-6 columns'>"
                    +"<img src=https://maps.googleapis.com/maps/api/staticmap?center="
                    +story.geo_facet[0]
                    +"&zoom=4&size=300x300&maptype=roadmap&markers=size:mid%7Ccolor:0xff0000%7Clabel:1%7C"
                    +story.geo_facet[0]
                    +"&key=<%= ENV['google_static_maps_api_key'] %>"
                    +">"
                +"</div>"
                +"<div class='medium-6 columns story_image'>"
                +"</div>"
            +"</div>"
            +"</div>"
            +"<hr>"

    );
}

